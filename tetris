<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>tetris</title>
</head>

<style>
    .moving {margin: 1px;width: 29px;height: 29px;background: red;color: chartreuse; position: absolute;}
    .resting {margin: 1px;width: 29px;height: 29px;background: aquamarine;color: aquamarine;position: absolute}
    .backGround {margin: 1px;width:30px;height:30px;color: black;background: black;position: absolute}
</style>

<body>

<script>
    var width=20,height=26

    var items=new Array(5)
    items[0]= [0x1111,0xf00
        // 1111
    ]
    items[1]=[0x7400,0x3110,0x1700,0x2230
        //111
        //1
    ]

    items[2]=[0x3600,0x2310
        //011
        //110
    ]

    items[3]=[0xcc00
        //11
        //11
    ]

    items[4]=[0x2700,0x2320,0x7200,0x1310
        //010
        //111
    ]

    var bg=new Array(height+1);//背景
    var itemPos={x:width/2,y:height/2}
    var itemIdx1=0,itemIdx2=0;

    function createSquare(posX,posY) {//创建一个小方块 左上角在(posX*30px,posY*30px)
        var square=document.createElement("div")
        square.className="backGround"
        document.body.appendChild(square)
        square.style.left+=posX*30+'px'
        square.style.right+=posX*30+'px'
        square.style.top+=posY*30+'px'
        return square
    }

    /*
     检查item能否在posX,posY位置
     撞左右边界返回0
     触底返回1
     否则返回2
     */
    function check(posX,posY,item) {
        for(var i=0;i<4;++i){
            var tmp = item>>(12-4*i)
            for(var j=0;j<4;++j){
                if(tmp&(1<<(3-j))){
                    if(posY+i<0||posY+i>height||posX+j<0||posX+j>width){
                        return 0;
                    }
                }
            }
        }

        for(var i=0;i<4;++i){
            var tmp = item>>(12-4*i)
            for(var j=0;j<4;++j){
                if(tmp&(1<<(3-j))){
                    if(bg[posY+i][posX+j].className=="resting"){
                        return 1;
                    }
                }
            }
        }
        return 2
    }

    function drawItem(posX,posY,item,css) {//以css作为style绘制item
        for(var i=0;i<4;++i){
            var tmp = item>>(12-4*i)
            for(var j=0;j<4;++j){
                if(tmp&(1<<(3-j))){
                    bg[posY+i][posX+j].className=css
                }
            }
        }
    }

    function clearLine(line) {
        for(var i=line;i>1;--i){
            for(var j=0;j<width;++j) {
                bg[i][j].className=bg[i-1][j].className;
            }
        }
    }

    function checkFull(posY) {
        for(var i=posY;i<posY+4&&i<height;++i){
            var j
            for(j=0;j<width;++j){
                if(bg[i][j].className!="resting"){
                    break
                }
            }
            if(j==width){
                clearLine(i)
            }
        }
    }

    function down() {
        drawItem(itemPos.x,itemPos.y,items[itemIdx1][itemIdx2],"backGround")
        itemPos.y+=1
        var checkAns=check(itemPos.x,itemPos.y,items[itemIdx1][itemIdx2])
        if(checkAns==1){
            drawItem(itemPos.x,itemPos.y-1,items[itemIdx1][itemIdx2],"resting")
            if(itemPos.y<=1) {
                GameOver()
            }
            checkFull(itemPos.y-1)
            getItem()
        }
        else{
            drawItem(itemPos.x,itemPos.y,items[itemIdx1][itemIdx2],"moving")
        }
    }

    document.onkeydown=function (event) {
        event=event==window.event?window.event:event
        switch (event.keyCode){
            case 38://上
                drawItem(itemPos.x,itemPos.y,items[itemIdx1][itemIdx2],"backGround")
                itemIdx2+=1
                itemIdx2%=items[itemIdx1].length
                var i
                for(i=0;i<4&&check(itemPos.x,itemPos.y,items[itemIdx1][itemIdx2])==0&&itemPos.x>=0;++i){
                        itemPos.x-=1;
                }
                if(i==4||itemPos.x<0){
                    itemPos.x+=i
                }
                while (check(itemPos.x,itemPos.y,items[itemIdx1][itemIdx2])==0){
                    itemPos.x+=1
                }
                drawItem(itemPos.x,itemPos.y,items[itemIdx1][itemIdx2],"moving")
                break;
            case 40://下
                down()
                break;
            case 37://左
                    if(check(itemPos.x-1,itemPos.y,items[itemIdx1][itemIdx2])) {
                        drawItem(itemPos.x, itemPos.y, items[itemIdx1][itemIdx2], "backGround")
                        itemPos.x -= 1
                        drawItem(itemPos.x, itemPos.y, items[itemIdx1][itemIdx2], "moving")
                    }
                break;
            case 39://右
                if(check(itemPos.x+1,itemPos.y,items[itemIdx1][itemIdx2])) {
                    drawItem(itemPos.x, itemPos.y, items[itemIdx1][itemIdx2], "backGround")
                    itemPos.x += 1
                    drawItem(itemPos.x, itemPos.y, items[itemIdx1][itemIdx2], "moving")
                }
                break;
        }
    }

    function getItem() {
        itemPos.x=width/2
        itemPos.y=0
        itemIdx1=~~(Math.random()*items.length)
        itemIdx2=~~(Math.random()*items[itemIdx1].length)
        drawItem(itemPos.x,itemPos.y,items[itemIdx1][itemIdx2],"moving")
    }

    var interVal

    function GameOver() {
        alert("GameOver")
        window.clearInterval(interVal)
    }

    var board=createSquare(0,0)
    board.style.width=30*width+'px'
    board.style.height=30*height+'px'

    for(var i=0;i<height;++i){
        bg[i]=new Array(width)
        for(var j=0;j<width;++j) {
            bg[i][j] = createSquare(j, i)
        }
    }
    bg[height]=new Array(width)
    for(var i=0;i<width;++i){
        bg[height][i]=createSquare(i,height)
        bg[height][i].className="resting"
        bg[height][i].style.display="none"
    }

    getItem()
    interVal=window.setInterval("down()",300)

</script>

</body>

</html>
